---
layout: post
title: "구글 SRE팀의 모니터링"
description: "구글 SRE팀의 모니터링 원리."
date: 2018-04-22
tags: [Goolge, SRE, Monitoring, 모니터링]
comments: true
share: true
---

![사이트신뢰성엔지니어링](/images/2018-04-21-sre-monitoring/sre.png)

[사이트신뢰성엔지니어링](http://kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&barcode=9791188621088&orderClick=LA6)은 구글의 SRE팀이 무엇인지 그리고 어떤 일들을 하는지에 대해서 설명하는 책입니다.

이 글은 구글이 공개하는 [사이트신뢰성엔지니어링](http://kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&barcode=9791188621088&orderClick=LA6) 책에 있는 챕터 6의 분산 시스템 모니터링을 정리한 것입니다.

# 1. 정의

## 1-1 모니터링

* 리퀘스트 카운트와 종류, 에러의 수와 종류, 처리 시간 및 서버의 활동 시간등 시스템에 대한 정량적 실시간 데이터를 모으로 처리하고 집계해서 보여주는 것

## 1-2 화이트박스 모니터링

* 로그나 JVM의 프로파일링 인터페이스 같은 인터페이스 혹은 내부의 통계지표를 제공하는 HTTP 핸들러 등을 이용해서 얻은 시스템의 내부 지표들을 토대로 하는 모니터링

## 1-3 블랙박스 모니터링

* 사용자가 보게 되는 확인 가능한 동작들을 외부에서 테스트하는 과정

## 1-4 대시보드

* 서비스의 핵심 지표에 대한 용약된 뷰를 보여주는 애플리케이션. 가장 중요한 지표들을 사용자에게 보여주도록 한다.
* 현재 비상 대기 중인 엔지니어와 담당하는 분야 혹은 최근에 배포된 코드 등 팀과 관련된 정보를 보여준다.

## 1-5 알람

* 사람이 읽을 수 있도록 작성된 노티

# 2. 왜 모니터링해야 하는가

## 2-1 장기적인 트랜드 분석

* 데이터베이스의 크기는 얼마나 되며, 얼마나 빠르게 증가하고 있는가?
* 실 사용자의 수는 얼마나 빠르게 증가하고 있는가?

## 2-2 시간 순 혹은 실험 그룹에 대한 비교

* 맴캐시의 활용률은 어느 정도나 좋아지는가?
* 지난 주 대비 사이트가 느려졌는가?

## 2-3 임시적인 회고 분석의 수행

* 갑자기 지연응답이 발생했는데 그 시간에 다른 어떤 일들이 발행했었는가?
* 시스템 모니터링은 비즈니스 분석 및 좀 더 원활한 보안 취약점 분석을 위한 원천 데이터를 확보하는 데 도움이 된다.

> 모니터링과 알람을 이용하면 시스템에 언제 문제가 발생했는지 또는 어떤 문제가 발생하려 하는지는 알 수 있다.  
> **<mark>실제로 문제가 발생했는지를 살펴보고 증상을 처리한 후, 문제가 발생한 근본적인 원인을 파악</mark>**해야 한다.  
> **효과적인 알림 시스템은 정확한 신호와 낮은 오보 비율을 갖춰야 한다.**

# 3. 모니터링에 대한 적절한 기대치 설정하기

* **복잡한 시스템을 모니터링하는 것은 의미 있는 엔지니어링 노력이자, 그 자체로도 큰 의미를 갖는다.**
* **누군가 문제를 확인하기 위해 화면을 들여다보는 상황을 배제하도록 노력**한다.
* **<mark>임계값을 학습하고 자동으로 인과관계를 찾아내는 마법 같은 시스템은 선호하지 않는다.</mark>**
* **<mark>모니터링 시스템에 있어 중요한 것은 최대한 간결하면서도 팀 모두가 이해할 수 있도록 유지하는 것이다.</mark>**

# 4. 증상과 원인

* **<mark>모니터링 시스템은 어떤 장애(증상)가 왜 발생했는지(원인)에 대한 질문에 답을 제기할 수 있어야 한다.</mark>**
  1. 예를들면, HTTP 500이 발생(증상)하였고 데이터베이스의 서버가 연결 요청을 거부했다(원인).
* 무엇과 왜는 최대 비율의 정상적 알림과 최소 비율의 오보를 목적으로 하는 모니터링 시스템을 작성할 때 고려해야 하는 가장 중요한 간극 중 하나다.

# 5. 블랙박스와 화이트박스

* **블랙박스 모니터링은** 현재 문제가 발생할 것으로 예상되는 것이 아니라 발생하는 상황을 모니터링 하는 것이다. 즉, **시스템이 지금 현재 올바로 동작하지 않고 있는 상황을 알기 위한 것.**
* 화이트박스 모니터링은 로그나 HTTP와 같은 시스템의 내부 동작들을 규범에 따라 살펴보는 기법들을 토대로 한다.
* **화이트박스 모니터링을 통해 어떤 정보를 얻느냐에 따라 증상에 초점을 맞출 수도 있고 원인에 초점을 맞출 수도 있다.**
  1. 예를들면, DB 읽기 작업이 느려진 현상은 DB SRE에게는 증상이지만 프론트엔드 SRE 입장에서는 웹페이지가 느려진 원인이 DB의 읽기 작업이 느려졌기 때문이다.

# 6. 네 가지 결정적인 지표 → 포인트

## <mark> 6-1 지연응답 </mark>

* 요청이 서비스에 의해 처리되기가지의 시간
* **에러 응답을 그냥 무시하는 것보다는 에러의 지연응답을 추적하는 것이 중요**하다.

## <mark> 6-2 트래픽 </mark>

* 시스템에 얼마나 많은 요청이 들어오는지를 측정 → 우리는 주로 리퀘스트

## <mark> 6-3 에러 </mark>

* 실패한 요청의 비율
  1. HTTP 500 에러들
  2. HTTP 200이지만 잘못된 콘텐츠가 제공된 경우
  3. 모든 응답을 1초 내에 제공하기로 했다면 1초 이상 소요된 응답은 에러다.
* **로드밸런서를 통해 모든 HTTP 500 에러를 검출하면 실패한 요청들을 모두 완벽하게 잡아낼 수 있다.**

## <mark> 6-4 서비스 포화 상태 </mark>

* 서비스가 얼마나 포화 상태로 동작하는지를 의미한다.
* **시스템의 일부를 측정하며 가장 병목이 발생하는 리소스를 집중해서 측정**해야 한다.
* **시스템의 포화 상태는 높은 수준의 부하 측정을 통해 보완할 수 있다.**
  1. 시스템의 두 배의 트래픽을 감당할 수 있는가?

# 7. 마지막 요청(혹은 실행과 성능)에 대한 고려

* 전에 요청에 대한 평균 응답 속도가 아니라, 전체 요청의 수와 전체 응답속도를 수집해야 한다.
  1. 예를들면, 10ms ~ 30ms 내에 응답된 리퀘스트의 수, 30ms ~ 100ms 내에 응답된 리퀘스트의 수, 100ms ~ 300ms 내에 응답된 리퀘스트의 수을 수집해야 한다.
  2. 경계를 대략적으로 산정해서 분포해보면 요청이 어떻게 분포되는지를 시각적으로 확인할 수 있다.

# 8. 적당한 측정 방법 선택하기

* **시스템의 지표들은 각기 다른 수준으로 세분화하여 측정되어야 한다.**
* 시스템을 측정할 때 어느정도로 세분화할 것인지에 대해 주의를 기울여야 한다.

# 9. 더욱 단순하게가 아니라 최대한 단순하게

* **모니터링 시스템을 디자인할 때는 최대한 간결함을 추구해야 한다.**
  1. 가장 빈번하게 발생하는 사건/사고를 탐지하기 위한 규칙은 최대한 간결하고 예측 가능하며 확실해야 한다.
  2. 수정 빈도가 높지 않는 데이터의 수집, 집계 그리고 알림에 관련된 설정은 제거한다.

* **지표의 기본적인 수집 및 집계된 데이터를 알림 및 대시보드에서 활용하면 모니터링 시스템을 구성하기에 부족함이 없다.**
* **복잡한 정보들은 기본적인 모니터링과 공유할 수 있는 부분들이 많기는 하지만 너무 많은 결과들을 섞어버리면 시스템이 너무 복잡해져서 결함이 생기기 쉽다.**

# 10. 모니터링과 알림에 대한 규칙

* 너무 많은 알림을 보내지 않도록 해야한다.
  1. 해당 알림이 존재하지 않는다면 알아챌 수 없는 긴급하게 대처가 가능하며 즉각적으로 사용자가 인지할 수 있는 상태를 탐지할 수 있는가?
  2. 긴급하지 않은 알림이라면 무시할 수 있는 알림인가? 언제, 왜 이 알림을 무시할 수 있으며, 이런 알림을 받지 않으려면 어떻게 해야 할까?
  3. 알림에 대해 대응이 가능한가? 이 알림은 긴급한 것인가 아니면 내일 아침까지 기다려도 되는 것인가?

* **알림 철학**
  1. **<mark>매번 알림이 발생할 때마다 긴급한 상황임을 인지하고 그에 대응할 수 있어야 한다.</mark>**
  2. **<mark>모든 알림은 대응이 가능해야 한다.</mark>**
  3. **<mark>알림에 대한 모든 대응은 이성적이어야 한다.</mark>**
  4. **<mark>알림은 새로운 문제가 지금까지 보지 못한 사건에 대한 것이어야 한다.</mark>**

> 과도한 알림은 줄여야 한다.  
> 성능을 개선하는 중이거나 급하게 처리하지 않아도 되는 문제들에 대해서 임계값을 조정하고 장기적인 문제들을 실질적으로 수정해나가야 한다.  
> 문제에 대한 근본적인 해결책을 마련하는 것보다는 문제를 해결하기 위해 관리의 어려움을 감수하고 기술 부채에 해당하는 우회책을 갖다 붙이는 것이 더 쉽다.  
> **<mark>관리자와 기술 리더들을 이런 문제 잠재적으로 엄청난 시간을 소요하게 될 장기적 해결책을 지원하고 올바른 우선순취를 책정하는 등, 그 구현에 있어 핵심적인 역할을 담당해야 한다.</mark>**

# 11. 결론

* 제대로 구성된 모니터링과 알림 파이프라인은 간결하고 명료하다.
* 모니터링 시스템은 증상을 탐지하는 것에 집중하며, 문제를 디버깅하기 위한 방안을 제시함으로써 원인 분석으로 통해 스스로 학습하고 성장할 수 있는 기회를 제공한다.
* 이메일 알림을 그다지 큰 가치를 제공하지 못한다.
* 대시보드를 로그와 결합하면 시간순으로 발생한 이벤트들의 연관 관계를 분석할 수도 있다.
* **성공적인 비상 대기 교대 운영 정책을 마련하고**
* **문제에 대한 증상이나 실제로 발생할 긴급한 문제에 대한 알림을 적절하게 선택할 수 있는 시스템**
* **그리고 실제로 달성 가능한 목표를 설정하고 모니터링 시스템이 그에 대한 신속한 분석을 지원할 수 있도록 하기 위해 노력이 필요하다.**